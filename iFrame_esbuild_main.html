<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>React App - Braintrust AppBuilder Demo</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        #root {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .loading {
            text-align: center;
            padding: 40px;
            color: #555;
            font-size: 16px;
        }
        .error {
            color: #d93f4c;
            padding: 20px;
            border: 1px solid #f5c6cb;
            border-radius: 4px;
            background-color: #f8d7da;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div id="root">
        <div class="loading">Loading application...</div>
    </div>

    <!-- React CDN -->
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.development.js"></script>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.development.js"></script>
    
    <!-- esbuild-wasm for bundling -->
    <script src="https://unpkg.com/esbuild-wasm@0.17.19/lib/browser.min.js"></script>

    <!-- Your React App -->
    <script>
        // Listen for messages containing file data
        function handleMessage(event) {
            const files = event.data.data?.output;
            
            if (!files || !Array.isArray(files)) {
                console.log("No valid files received in message");
                document.getElementById('root').innerHTML = `
                    <div class="error">
                        <h3>Error Loading Application</h3>
                        <p>No valid files received in the message.</p>
                    </div>
                `;
                return;
            }
            
            console.log("Received files:", files.map(f => f.args.filePath));
            
            // Filter out .md files
            const outputFiles = files.filter(file => !file.args.filePath.endsWith('.md'));
            
            // Start the bundling process with the received files
            initializeAndBundleApp(outputFiles);
        }

        // Main function to initialize esbuild and bundle the app
        async function initializeAndBundleApp(outputFiles) {
            try {
                console.log("Processing files:", outputFiles.map(f => f.args.filePath));

                // Initialize esbuild-wasm
                console.log("Initializing esbuild...");
                await esbuild.initialize({
                    wasmURL: 'https://unpkg.com/esbuild-wasm@0.17.19/esbuild.wasm',
                    worker: true
                });
                console.log("esbuild initialized successfully");

                // 1) First, load and apply all CSS/styles files
                const styleFiles = outputFiles.filter(file => 
                    file.args.filePath.includes('styles') || 
                    file.args.filePath.endsWith('.css') || 
                    file.args.filePath.includes('styles.js')
                );
                
                console.log('Style files found:', styleFiles.map(f => f.args.filePath));
                console.log('Style file content sample:', styleFiles[0]?.args.fileContent?.substring(0, 100));
                
                styleFiles.forEach(styleFile => {
                    console.log(`Loading styles from: ${styleFile.args.filePath}`);
                    const styleElement = document.createElement('style');
                    styleElement.textContent = styleFile.args.fileContent;
                    document.head.appendChild(styleElement);
                    console.log(`Styles loaded successfully from: ${styleFile.args.filePath}`);
                });
                
                // 2) Create a virtual file system from all the JS/JSX files (not CSS)
                const jsxFiles = outputFiles.filter(file => 
                    file.args.filePath.endsWith('.jsx') || 
                    (file.args.filePath.endsWith('.js') && !file.args.filePath.includes('styles.js'))
                );
                
                // Create a map of files for our virtual file system
                const virtualFileSystem = {};
                jsxFiles.forEach(file => {
                    // Ensure proper exports
                    if (file.args.filePath.includes('Component') || file.args.filePath.includes('component')) {
                        const content = file.args.fileContent;
                        // Ensure we have a proper export if using window assignment
                        if (content.includes('window.') && !content.includes('export default')) {
                            const componentName = file.args.filePath.split('/').pop().split('.')[0];
                            virtualFileSystem[file.args.filePath] = `${content}\nexport default ${componentName};`;
                        } else {
                            virtualFileSystem[file.args.filePath] = content;
                        }
                    } else {
                        virtualFileSystem[file.args.filePath] = file.args.fileContent;
                    }
                });
                
                console.log("Virtual file system created with files:", Object.keys(virtualFileSystem));
                
                // Find the entry point (index.jsx)
                const entryPoint = jsxFiles.find(file => 
                    file.args.filePath.endsWith('index.jsx') || 
                    file.args.filePath.endsWith('App.jsx') || 
                    file.args.filePath.endsWith('main.jsx')
                )?.args.filePath;
                
                if (!entryPoint) {
                    throw new Error("No suitable entry point found (index.jsx, App.jsx, or main.jsx)");
                }
                
                console.log(`Using entry point: ${entryPoint}`);
                
                // Create a plugin to resolve imports from our virtual file system
                const virtualFsPlugin = {
                    name: 'virtual-fs',
                    setup(build) {
                        // Handle all file resolution
                        build.onResolve({ filter: /.*/ }, args => {
                            if (args.kind === 'entry-point') {
                                return { path: args.path, namespace: 'virtual-fs' };
                            }
                            
                            // Handle relative imports
                            if (args.path.startsWith('./') || args.path.startsWith('../')) {
                                let normalizedPath = args.path;
                                let resolveDir = args.resolveDir || '';
                                
                                // Remove ./ from the beginning
                                if (normalizedPath.startsWith('./')) {
                                    normalizedPath = normalizedPath.substring(2);
                                }
                                
                                // Construct the full path
                                const basePath = resolveDir ? `${resolveDir}/` : '';
                                const fullPath = `${basePath}${normalizedPath}`;
                                
                                // Check if the file exists in our virtual file system
                                const possiblePaths = [
                                    fullPath,
                                    `${fullPath}.jsx`,
                                    `${fullPath}.js`,
                                    // Handle CSS imports
                                    normalizedPath,
                                    `${normalizedPath}.js`
                                ];
                                
                                for (const path of possiblePaths) {
                                    if (virtualFileSystem[path]) {
                                        return { path, namespace: 'virtual-fs' };
                                    }
                                }
                                
                                console.warn(`Could not resolve: ${args.path} from ${resolveDir}`);
                            }
                            
                            // Pass through external dependencies (like React)
                            return { path: args.path, external: true };
                        });
                        
                        // Load files from virtual file system
                        build.onLoad({ filter: /.*/, namespace: 'virtual-fs' }, args => {
                            const fileContent = virtualFileSystem[args.path];
                            
                            if (fileContent) {
                                // Determine loader based on file extension
                                const loader = args.path.endsWith('.css') ? 'css' : 'jsx';
                                const resolveDir = args.path.split('/').slice(0, -1).join('/');
                                
                                return { 
                                    contents: fileContent, 
                                    loader, 
                                    resolveDir 
                                };
                            }
                            
                            return null;
                        });
                    }
                };
                
                // Bundle the application
                console.log("Starting bundle process...");
                
                // Handle CSS imports to prevent esbuild errors
                try {
                    if (virtualFileSystem[entryPoint]) {
                        console.log("Processing entry point for CSS imports");
                        const indexContent = virtualFileSystem[entryPoint];
                        
                        // Replace any CSS/style imports with comments
                        const modifiedContent = indexContent
                            .replace(/import\s+['"]\.\/(styles|css)\/.*?['"];?\s*/g, '// CSS styles are loaded separately\n')
                            .replace(/import\s+['"]\.\.\/styles\/.*?['"];?\s*/g, '// CSS styles are loaded separately\n');
                        
                        // Log what changed
                        if (modifiedContent !== indexContent) {
                            console.log("Removed CSS imports from entry point");
                        } else {
                            console.log("No CSS imports found in entry point");
                        }
                        
                        virtualFileSystem[entryPoint] = modifiedContent;
                    }
                } catch (err) {
                    console.warn("Error processing CSS imports:", err);
                    // Continue anyway - CSS is loaded separately
                }

                let result;
                try {
                    result = await esbuild.build({
                        entryPoints: [entryPoint],
                        bundle: true,
                        format: 'iife',  // Immediately Invoked Function Expression
                        globalName: 'AppBundle',
                        jsx: 'transform',
                        jsxFactory: 'React.createElement',
                        jsxFragment: 'React.Fragment',
                        plugins: [virtualFsPlugin],
                        define: {
                            'process.env.NODE_ENV': '"development"',
                            'React': 'window.React',
                            'ReactDOM': 'window.ReactDOM'
                        },
                        external: ['*.css', '*.scss'],  // Don't try to bundle CSS files
                        write: false, // Output to memory
                        logLevel: 'info'
                    });
                } catch (buildError) {
                    console.error("esbuild build failed:", buildError);
                    
                    // Try a simpler approach as fallback
                    console.log("Attempting fallback build without CSS imports...");
                    
                    // Additional cleanup of problematic imports in all files
                    Object.keys(virtualFileSystem).forEach(key => {
                        virtualFileSystem[key] = virtualFileSystem[key].replace(
                            /import\s+['"].*?\.(css|scss|less|styles)['"];?\s*/g,
                            '// CSS import removed\n'
                        );
                    });
                    
                    // Try again with the cleaned files
                    result = await esbuild.build({
                        entryPoints: [entryPoint],
                        bundle: true,
                        format: 'iife',
                        globalName: 'AppBundle',
                        jsx: 'transform',
                        jsxFactory: 'React.createElement',
                        jsxFragment: 'React.Fragment',
                        plugins: [virtualFsPlugin],
                        define: {
                            'process.env.NODE_ENV': '"development"',
                            'React': 'window.React',
                            'ReactDOM': 'window.ReactDOM'
                        },
                        external: ['*.css', '*.scss', '*.styles.js'],
                        write: false
                    });
                }
                
                console.log("Bundle completed successfully");
                
                if (result.errors.length > 0) {
                    console.error("Build errors:", result.errors);
                    throw new Error(`Build failed with ${result.errors.length} errors`);
                }
                
                if (result.warnings.length > 0) {
                    console.warn("Build warnings:", result.warnings);
                }
                
                // Execute the bundled code
                const bundledCode = result.outputFiles[0].text;
                console.log("Bundled code size:", bundledCode.length, "bytes");
                
                // Make React and ReactDOM available in the global scope
                window.React = React;
                window.ReactDOM = ReactDOM;
                
                // Execute the bundled code
                try {
                    const scriptEl = document.createElement('script');
                    scriptEl.textContent = bundledCode;
                    document.body.appendChild(scriptEl);
                    
                    console.log("Bundled code executed");
                    
                    // Render the React app
                    const root = ReactDOM.createRoot(document.getElementById('root'));
                    
                    // Check for the component in different possible locations
                    if (window.AppBundle?.default) {
                        console.log("Rendering AppBundle.default component");
                        root.render(React.createElement(window.AppBundle.default));
                    } else if (typeof window.AppBundle === 'function') {
                        console.log("Rendering AppBundle component as function");
                        root.render(React.createElement(window.AppBundle));
                    } else if (window.App) {
                        console.log("Rendering App component");
                        root.render(React.createElement(window.App));
                    } else {
                        // Look for any React component in the global namespace
                        const components = Object.keys(window).filter(key => {
                            return typeof window[key] === 'function' &&
                                key !== 'React' &&
                                key !== 'ReactDOM' &&
                                !key.startsWith('_');
                        });
                        
                        if (components.length > 0) {
                            const componentName = components[0];
                            console.log(`Found component ${componentName}. Rendering...`);
                            root.render(React.createElement(window[componentName]));
                        } else {
                            throw new Error("No React component found to render");
                        }
                    }
                    
                    console.log("App mounted successfully");
                    
                } catch (error) {
                    console.error("Error executing bundle:", error);
                    throw error;
                }
                
            } catch (error) {
                console.error("Error during bundling or rendering:", error);
                document.getElementById('root').innerHTML = `
                    <div class="error">
                        <h3>Error in Application</h3>
                        <p>${error.message}</p>
                        <pre style="background: #f8f9fa; padding: 10px; overflow: auto; max-height: 300px;">${error.stack}</pre>
                    </div>
                `;
            }
        }
        
        // Listen for messages containing file data
        window.addEventListener('message', handleMessage);
        
        console.log("Message listener registered. Send data via window.postMessage()");
    </script>
</body>
</html>