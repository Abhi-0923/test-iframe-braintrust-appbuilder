<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>React App - Braintrust AppBuilder Demo</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        #root {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <!-- React CDN -->
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.development.js"></script>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.development.js"></script>
    
    <!-- esbuild-wasm for bundling -->
    <script src="https://unpkg.com/esbuild-wasm@0.17.19/lib/browser.min.js"></script>

<!-- Your React App -->
<script>
    const data = {
        "type": "data",
        "data": {
            "_pagination_key": "p07535305238268870656",
            "_xact_id": "1000195571892760302",
            "created": "2025-08-06T03:12:46.914Z",
            "id": "7fedaa20-c041-4bdc-943e-28b3904ea1dc",
            "metadata": {},
            "metrics": {
                "end": 1754450069.843,
                "start": 1754449966.914,
                "prompt_tokens": 25922,
                "completion_tokens": 1749,
                "tokens": 27671,
                "estimated_cost": 0.104001
            },
            "origin": null,
            "root_span_id": "851a36c1-b43b-4f8f-8ad0-4133979e4cd2",
            "scores": null,
            "span_attributes": {
                "exec_counter": 0,
                "name": "eval",
                "type": "eval"
            },
            "span_id": "851a36c1-b43b-4f8f-8ad0-4133979e4cd2",
            "tags": [],
            "context": {},
            "expected": "The currentUser value is retrieved using zafClient.get('currentUser')",
            "experiment_id": "e6825aa8-a7f0-4501-8bea-e268e7d94436",
            "input": "Create an app that displays current agent information",
            "is_root": true,
            "output": [
                {
                    "args": {
                        "fileContent": "const { useState } = React;\nimport SomeComponent from './components/someComponent'\nimport './styles/styles.js'; \nconst App = () => {\n    const [count, setCount] = useState(0);\n\n    return (\n        <div>\n            <h1>Hello World from React!</h1>\n            <p>This React app is running from CDN without any build process.</p>\n            <SomeComponent count={count} />\n            <div style={{ marginTop: '20px' }}>\n                <button \n                    onClick={() => setCount(count + 1)}\n                    className=\"click-button\"\n                >\n                    Clicked {count} times\n                </button>\n            </div>\n            <div style={{ marginTop: '20px', color: '#666' }}>\n                <small>React {React.version} loaded from CDN</small>\n            </div>\n        </div>\n    );\n}\n\nexport default App;",
                        "filePath": "index.jsx",
                        "operation": "add"
                    },
                    "toolCallId": "toolu_bdrk_01GecPhV165SBq636UvxTquA",
                    "toolName": "updateCode",
                    "type": "tool-call"
                },
                {
                    "args": {
                        "fileContent": "/* Styles for the React app */\n.click-button {\n    padding: 10px 20px;\n    font-size: 16px;\n    background-color: #61dafb;\n    border: none;\n    border-radius: 4px;\n    cursor: pointer;\n    transition: background-color 0.2s;\n}\n\n.click-button:hover {\n    background-color: #21a9c7;\n}\n\n.component-container {\n    padding: 16px;\n    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif;\n    background-color: #f8f9fa;\n    border-radius: 8px;\n    margin: 10px 0;\n}\n\n.component-title {\n    color: #333;\n    margin: 0 0 8px 0;\n    font-size: 18px;\n}",
                        "filePath": "styles/styles.js",
                        "operation": "add"
                    },
                    "toolCallId": "toolu_bdrk_01GecPhV165SBq636UvxTquA",
                    "toolName": "updateCode",
                    "type": "tool-call"
                },
                {
                    "args": {
                        "fileContent": "function SomeComponent({ count }) {\n    return (\n        <div className=\"component-container\">\n            <h3 className=\"component-title\">Some Component</h3>\n            <p>This is a separate component that receives count: <strong>{count}</strong></p>\n            <p>Component loaded from components/someComponent.jsx</p>\n        </div>\n    );\n}\n\n// Export for use in other files\nwindow.SomeComponent = SomeComponent;",
                        "filePath": "components/someComponent.jsx",
                        "operation": "add"
                    },
                    "toolCallId": "toolu_bdrk_01GecPhV165SBq636UvxTquA",
                    "toolName": "updateCode",
                    "type": "tool-call"
                }
            ]
        }
    };

    // Extract files from the data structure
    const outputFiles = data.data.output;
    
    // Show loading state
    document.getElementById('root').innerHTML = '<div style="padding: 20px; text-align: center;">Loading application...</div>';
    
    async function initializeAndBundleApp() {
        try {
            console.log("Initializing esbuild...");
            
            // Initialize esbuild-wasm
            await esbuild.initialize({
                wasmURL: 'https://unpkg.com/esbuild-wasm@0.17.19/esbuild.wasm',
                worker: true
            });
            
            console.log("esbuild initialized successfully");
            console.log("Processing files:", outputFiles.map(f => f.args.filePath));
        
            // 1) First, load and apply all CSS/styles files
            const styleFiles = outputFiles.filter(file => 
                file.args.filePath.includes('styles') || 
                file.args.filePath.endsWith('.css') || 
                file.args.filePath.includes('styles.js')
            );
            
            styleFiles.forEach(styleFile => {
                console.log(`Loading styles from: ${styleFile.args.filePath}`);
                const styleElement = document.createElement('style');
                styleElement.textContent = styleFile.args.fileContent;
                document.head.appendChild(styleElement);
                console.log(`Styles loaded successfully from: ${styleFile.args.filePath}`);
            });
            
            // 2) Create a virtual file system from all the JS/JSX files
            const jsxFiles = outputFiles.filter(file => 
                file.args.filePath.endsWith('.jsx') || file.args.filePath.endsWith('.js')
            );
            
            // Create a map of files for our virtual file system
            const virtualFileSystem = {};
            jsxFiles.forEach(file => {
                virtualFileSystem[file.args.filePath] = file.args.fileContent;
            });
            
            console.log("Virtual file system created with files:", Object.keys(virtualFileSystem));
            
            // Find the entry point (index.jsx)
            const entryPoint = jsxFiles.find(file => file.args.filePath.endsWith('index.jsx'))?.args.filePath;
            
            if (!entryPoint) {
                throw new Error("No index.jsx entry point found");
            }
            
            console.log(`Using entry point: ${entryPoint}`);
            
            // Create a plugin to resolve imports from our virtual file system
            const virtualFsPlugin = {
                name: 'virtual-fs',
                setup(build) {
                    // Handle all file resolution
                    build.onResolve({ filter: /.*/ }, args => {
                        if (args.kind === 'entry-point') {
                            return { path: args.path, namespace: 'virtual-fs' };
                        }
                        
                        // Handle relative imports
                        if (args.path.startsWith('./') || args.path.startsWith('../')) {
                            const basedir = args.resolveDir.split('/').slice(0, -1).join('/');
                            let normalizedPath = args.path;
                            
                            // Remove ./ from the beginning
                            if (normalizedPath.startsWith('./')) {
                                normalizedPath = normalizedPath.substring(2);
                            }
                            
                            // Construct the full path
                            const fullPath = basedir ? `${basedir}/${normalizedPath}` : normalizedPath;
                            
                            // Check if the file exists in our virtual file system
                            const possiblePaths = [
                                fullPath,
                                `${fullPath}.jsx`,
                                `${fullPath}.js`
                            ];
                            
                            for (const path of possiblePaths) {
                                if (virtualFileSystem[path]) {
                                    return { path, namespace: 'virtual-fs' };
                                }
                            }
                        }
                        
                        // Pass through external dependencies (like React)
                        return { path: args.path, external: true };
                    });
                    
                    // Load files from virtual file system
                    build.onLoad({ filter: /.*/, namespace: 'virtual-fs' }, args => {
                        const fileContent = virtualFileSystem[args.path];
                        
                        if (fileContent) {
                            const resolveDir = args.path.split('/').slice(0, -1).join('/');
                            return { contents: fileContent, loader: 'jsx', resolveDir };
                        }
                        
                        return null;
                    });
                }
            };
        
        // Process component code to make it compatible with browser evaluation
        function processComponentCode(code) {
            // Remove import statements since we're not using a module system
            let processedCode = code.replace(/import\s+.*?from\s+.*?;?\s*/g, '');
            processedCode = processedCode.replace(/import\s+.*?;?\s*/g, '');
            
            // Handle different types of export default statements
            
            // Case 1: export default ComponentName;
            processedCode = processedCode.replace(/export\s+default\s+([\w]+);?/g, 'window.$1 = $1;');
            
            // Case 2: export default function ComponentName() {...}
            const fnNameMatch = processedCode.match(/export\s+default\s+function\s+([\w]+)/);
            if (fnNameMatch) {
                const fnName = fnNameMatch[1];
                processedCode = processedCode.replace(/export\s+default\s+function\s+([\w]+)/g, 'function $1');
                processedCode += `\nwindow.${fnName} = ${fnName};`;
            }
            
            // Case 3: export default const/let/var ComponentName = () => {...}
            const varNameMatch = processedCode.match(/export\s+default\s+(const|let|var)\s+([\w]+)\s*=/);
            if (varNameMatch) {
                const varName = varNameMatch[2];
                processedCode = processedCode.replace(/export\s+default\s+(const|let|var)\s+([\w]+)\s*=/, '$1 $2 =');
                processedCode += `\nwindow.${varName} = ${varName};`;
            }
            
            // Case 4: export default () => {...} (anonymous function)
            if (processedCode.includes('export default () =>')) {
                processedCode = processedCode.replace('export default () =>', 'window.AnonymousComponent = () =>');
            }
            
            // Case 5: export default class Component {...}
            const classNameMatch = processedCode.match(/export\s+default\s+class\s+([\w]+)/);
            if (classNameMatch) {
                const className = classNameMatch[1];
                processedCode = processedCode.replace(/export\s+default\s+class\s+([\w]+)/, 'class $1');
                processedCode += `\nwindow.${className} = ${className};`;
            }
            
            return processedCode;
        }

        // 2) Load and execute all component files (excluding index.jsx)
        const componentFiles = outputFiles.filter(file => 
            file.args.filePath.endsWith('.jsx') && 
            !file.args.filePath.includes('index.jsx')
        );
        
        componentFiles.forEach(componentFile => {
            console.log(`Loading component from: ${componentFile.args.filePath}`);
            try {
                const componentCode = componentFile.args.fileContent;
                
                // Process component code (remove imports, handle exports)
                const processedCode = processComponentCode(componentCode);
                
                // Transform with Babel (just JSX transformation)
                const transformedCode = Babel.transform(processedCode, { presets: ['react'] }).code;
                
                // Evaluate the code
                window.eval(transformedCode);
                
                console.log(`Component loaded successfully from: ${componentFile.args.filePath}`);
            } catch (error) {
                console.error(`Failed to load component from ${componentFile.args.filePath}:`, error);
            }
        });
        
        // 3) Load and execute the main index file
        const indexFile = outputFiles.find(file => 
            file.args.filePath.endsWith('index.jsx')
        );
        
        if (indexFile) {
            console.log(`Loading main app from: ${indexFile.args.filePath}`);
            try {
                // Get the main app code
                const mainCode = indexFile.args.fileContent;
                
                // Process the main code (remove imports, handle exports)
                const processedCode = processComponentCode(mainCode);
                
                // Transform with Babel
                const transformedCode = Babel.transform(processedCode, { presets: ['react'] }).code;
                console.log(`Transformed main app code:`, processedCode);
                
                // Evaluate the code
                window.eval(transformedCode);
                
                console.log("Main app loaded successfully");
                console.log("Available in window:", Object.keys(window).filter(k => typeof window[k] === "function" && k !== "eval" && !k.startsWith("_")));
                
                // Mount the React app
                const root = ReactDOM.createRoot(document.getElementById('root'));
                
                // Look for the main component
                // Try to find the main component in different possible exports
                const possibleComponents = ['App', 'HelloWorld', 'Main', 'Component', 'AnonymousComponent'];
                const availableComponents = Object.keys(window).filter(k => 
                    typeof window[k] === 'function' && 
                    !k.startsWith('_') && 
                    k !== 'eval' && 
                    k !== 'fetch'
                );
                
                console.log('Available components in window:', availableComponents);
                
                // Find a component to render
                let componentToRender = null;
                
                // First check the specified list
                for (const componentName of possibleComponents) {
                    if (window[componentName]) {
                        componentToRender = window[componentName];
                        console.log(`Found component to render: ${componentName}`);
                        break;
                    }
                }
                
                // If not found, try any available component as fallback
                if (!componentToRender && availableComponents.length > 0) {
                    const componentName = availableComponents[0];
                    componentToRender = window[componentName];
                    console.log(`Using first available component: ${componentName}`);
                }
                
                if (componentToRender) {
                    try {
                        console.log(`Rendering component:`, componentToRender);
                        root.render(React.createElement(componentToRender));
                        console.log("App mounted successfully");
                    } catch (error) {
                        console.error("Error rendering component:", error);
                        document.getElementById('root').innerHTML = `
                            <div style="padding: 20px; color: #d93f4c;">
                                <h3>Error rendering component</h3>
                                <p>${error.message}</p>
                                <pre style="background: #f8f9fa; padding: 10px;">${error.stack}</pre>
                            </div>
                        `;
                    }
                } else {
                    console.error("No component found to render");
                    document.getElementById('root').innerHTML = `
                        <div style="padding: 20px; color: #d93f4c;">
                            <h3>No component found to render</h3>
                            <p>Make sure your main component is exported as "App", "HelloWorld", or using a default export.</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error("Error loading main app:", error);
            }
        } else {
            console.error("No index.jsx file found");
        }
        
    } catch (error) {
        console.error("Error during execution:", error);
    }
</script>
</body>
</html>