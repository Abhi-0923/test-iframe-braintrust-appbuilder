<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>React App - Braintrust AppBuilder Demo</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        #root {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <!-- React CDN -->
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.development.js"></script>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.development.js"></script>
    
    <!-- Babel Standalone for JSX transformation with modules support -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.22.5/babel.min.js"></script>

    <!-- Your React App -->
    <script type="text/babel">
        function handleMessage(event) {
            const files = event.data.data?.output;
            
            if (!files || !Array.isArray(files)) {
                console.log("No valid files received in message");
                return;
            }
            
            console.log("Received files:", files.map(f => f.args.filePath));
            
            // Filter out .md files
            const outputFiles = files.filter(file => !file.args.filePath.endsWith('.md'));
            
            try {
                console.log("Processing files:", outputFiles.map(f => f.args.filePath));
                
                // First, load and apply all CSS/styles files
                const styleFiles = outputFiles.filter(file => 
                    file.args.filePath.includes('styles') || 
                    file.args.filePath.endsWith('.css') || 
                    file.args.filePath.includes('styles.js')
                );
                
                styleFiles.forEach(styleFile => {
                    console.log(`Loading styles from: ${styleFile.args.filePath}`);
                    // Create a style element and append CSS
                    const styleElement = document.createElement('style');
                    styleElement.textContent = styleFile.args.fileContent;
                    document.head.appendChild(styleElement);
                    console.log(`Styles loaded successfully from: ${styleFile.args.filePath}`);
                });
                
                // Process component code to make it compatible with browser evaluation
                function processComponentCode(code) {
                    // Remove import statements since we're not using a module system
                    let processedCode = code.replace(/import\s+.*?from\s+.*?;?\s*/g, '');
                    processedCode = processedCode.replace(/import\s+.*?;?\s*/g, '');
                    
                    // Handle different types of export default statements
                    
                    // Case 1: export default ComponentName;
                    processedCode = processedCode.replace(/export\s+default\s+([\w]+);?/g, 'window.$1 = $1;');
                    
                    // Case 2: export default function ComponentName() {...}
                    const fnNameMatch = processedCode.match(/export\s+default\s+function\s+([\w]+)/);
                    if (fnNameMatch) {
                        const fnName = fnNameMatch[1];
                        processedCode = processedCode.replace(/export\s+default\s+function\s+([\w]+)/g, 'function $1');
                        processedCode += `\nwindow.${fnName} = ${fnName};`;
                    }
                    
                    // Case 3: export default const/let/var ComponentName = () => {...}
                    const varNameMatch = processedCode.match(/export\s+default\s+(const|let|var)\s+([\w]+)\s*=/);
                    if (varNameMatch) {
                        const varName = varNameMatch[2];
                        processedCode = processedCode.replace(/export\s+default\s+(const|let|var)\s+([\w]+)\s*=/, '$1 $2 =');
                        processedCode += `\nwindow.${varName} = ${varName};`;
                    }
                    
                    // Case 4: export default () => {...} (anonymous function)
                    if (processedCode.includes('export default () =>')) {
                        processedCode = processedCode.replace('export default () =>', 'window.AnonymousComponent = () =>');
                    }
                    
                    // Case 5: export default class Component {...}
                    const classNameMatch = processedCode.match(/export\s+default\s+class\s+([\w]+)/);
                    if (classNameMatch) {
                        const className = classNameMatch[1];
                        processedCode = processedCode.replace(/export\s+default\s+class\s+([\w]+)/, 'class $1');
                        processedCode += `\nwindow.${className} = ${className};`;
                    }
                    
                    return processedCode;
                }
                
                // First pass: Transform and load all component files (excluding index.jsx)
                const componentFiles = outputFiles.filter(file => 
                    file.args.filePath.endsWith('.jsx') && 
                    !file.args.filePath.endsWith('index.jsx')
                );
                
                componentFiles.forEach(componentFile => {
                    try {
                        console.log(`Loading component from: ${componentFile.args.filePath}`);
                        const componentCode = componentFile.args.fileContent;
                        
                        // Process the component code
                        const processedCode = processComponentCode(componentCode);
                        
                        // Transform with Babel and execute
                        const transformedCode = Babel.transform(processedCode, { presets: ['react'] }).code;
                        console.log(`Transformed component code for ${componentFile.args.filePath}:`, transformedCode);
                        
                        // Evaluate the code
                        window.eval(transformedCode);
                        
                        console.log(`Component loaded successfully from: ${componentFile.args.filePath}`);
                    } catch (error) {
                        console.error(`Failed to load component from ${componentFile.args.filePath}:`, error);
                    }
                });
                
                // Finally, load and execute the main index file
                const indexFile = outputFiles.find(file => 
                    file.args.filePath.endsWith('index.jsx')
                );
                
                if (indexFile) {
                    try {
                        console.log(`Loading main app from: ${indexFile.args.filePath}`);
                        // Get the main app code
                        const mainCode = indexFile.args.fileContent;
                        
                        // Process the code to handle exports and imports
                        const processedCode = processComponentCode(mainCode);
                        
                        // Transform with Babel
                        const transformedCode = Babel.transform(processedCode, { presets: ['react'] }).code;
                        console.log(`Processing completed for main app:`, processedCode);
                        
                        // Evaluate the code
                        window.eval(transformedCode);
                        
                        console.log("Main app loaded successfully");
                        console.log("Available in window:", Object.keys(window).filter(k => typeof window[k] === "function" && k !== "eval" && !k.startsWith("_")));
                        
                        // Mount the React app
                        const root = ReactDOM.createRoot(document.getElementById('root'));
                        
                        // Try to find the main component in different possible exports
                        const possibleComponents = ['App', 'HelloWorld', 'Main', 'Component', 'AnonymousComponent'];
                        const availableComponents = Object.keys(window).filter(k => 
                            typeof window[k] === 'function' && 
                            !k.startsWith('_') && 
                            k !== 'eval' && 
                            k !== 'fetch'
                        );
                        
                        console.log('Available components in window:', availableComponents);
                        
                        // Find a component to render
                        let componentToRender = null;
                        
                        // First check the specified list
                        for (const componentName of possibleComponents) {
                            if (window[componentName]) {
                                componentToRender = window[componentName];
                                console.log(`Found component to render: ${componentName}`);
                                break;
                            }
                        }
                        
                        // If not found, try any available component as fallback
                        if (!componentToRender && availableComponents.length > 0) {
                            const componentName = availableComponents[0];
                            componentToRender = window[componentName];
                            console.log(`Using first available component: ${componentName}`);
                        }
                        
                        if (componentToRender) {
                            try {
                                console.log(`Rendering component:`, componentToRender);
                                root.render(React.createElement(componentToRender));
                                console.log("App mounted successfully");
                            } catch (error) {
                                console.error("Error rendering component:", error);
                                document.getElementById('root').innerHTML = `
                                    <div style="padding: 20px; color: #d93f4c;">
                                        <h3>Error rendering component</h3>
                                        <p>${error.message}</p>
                                        <pre style="background: #f8f9fa; padding: 10px;">${error.stack}</pre>
                                    </div>
                                `;
                            }
                        } else {
                            console.error("No component found to render");
                            document.getElementById('root').innerHTML = `
                                <div style="padding: 20px; color: #d93f4c;">
                                    <h3>No component found to render</h3>
                                    <p>Make sure your main component is exported as "App", "HelloWorld", or using a default export.</p>
                                </div>
                            `;
                        }
                    } catch (error) {
                        console.error("Error loading main app:", error);
                    }
                } else {
                    console.error("No index.jsx file found");
                }
                
            } catch (error) {
                console.error("Error during execution:", error);
            }
        }

        // Listen for messages containing file data
        window.addEventListener('message', handleMessage);
        
        console.log("Message listener registered. Send data via window.postMessage()");
    </script>
</body>
</html>