<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>React Hello World - CDN</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        #root {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <!-- React CDN -->
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.development.js"></script>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.development.js"></script>
    
    <!-- Babel Standalone for JSX transformation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.22.5/babel.min.js"></script>

    <!-- Your React App -->
    <script type="text/babel">
        function handleMessage(event) {
            const files = event.data.data?.output;
            
            if (!files || !Array.isArray(files)) {
                console.log("No valid files received in message");
                return;
            }
            
            console.log("Received files:", files.map(f => f.args.filePath));
            
            // Filter out .md files
            const outputFiles = files.filter(file => !file.args.filePath.endsWith('.md'));
            
            try {
                // Dynamically process all files based on their extensions and paths
                console.log("Processing files:", outputFiles.map(f => f.args.filePath));
                
                // First, load and apply all CSS/styles files
                const styleFiles = outputFiles.filter(file => 
                    file.args.filePath.includes('styles') || 
                    file.args.filePath.endsWith('.css') || 
                    file.args.filePath.includes('styles.js')
                );
                
                styleFiles.forEach(styleFile => {
                    console.log(`Loading styles from: ${styleFile.args.filePath}`);
                    // Create a style element and append CSS
                    const styleElement = document.createElement('style');
                    styleElement.textContent = styleFile.args.fileContent;
                    document.head.appendChild(styleElement);
                    console.log(`Styles loaded successfully from: ${styleFile.args.filePath}`);
                });
                
                // Second, load and execute all component files (excluding index.jsx)
                const componentFiles = outputFiles.filter(file => 
                    file.args.filePath.endsWith('.jsx') && 
                    !file.args.filePath.endsWith('index.jsx')
                );
                
                componentFiles.forEach(componentFile => {
                    console.log(`Loading component from: ${componentFile.args.filePath}`);
                    const componentCode = componentFile.args.fileContent;
                    
                    // Remove any import statements from component files
                    let cleanComponentCode = componentCode.replace(/import\s+.*?from\s+.*?;?\s*/g, '');
                    cleanComponentCode = cleanComponentCode.replace(/import\s+.*?;?\s*/g, '');
                    
                    const transformedComponentCode = Babel.transform(cleanComponentCode, { 
                        presets: ['react'] 
                    }).code;
                    window.eval(transformedComponentCode);
                    console.log(`Component loaded successfully from: ${componentFile.args.filePath}`);
                });
                
                // Finally, load and execute the main index file
                const indexFile = outputFiles.find(file => 
                    file.args.filePath.endsWith('index.jsx')
                );
                
                if (indexFile) {
                    console.log(`Loading main app from: ${indexFile.args.filePath}`);
                    let mainCode = indexFile.args.fileContent;
                    
                    // Remove ALL import statements since we're not using a module system
                    mainCode = mainCode.replace(/import\s+.*?from\s+.*?;?\s*/g, '');
                    mainCode = mainCode.replace(/import\s+.*?;?\s*/g, '');
                    
                    console.log("Main app code after import removal:", mainCode);
                    
                    const transformedMainCode = Babel.transform(mainCode, { 
                        presets: ['react'] 
                    }).code;
                    
                    console.log("Transformed main code:", transformedMainCode);
                    
                    window.eval(transformedMainCode);
                    console.log("Main app loaded successfully");
                    
                    // Mount the React app - find the main component dynamically
                    const root = ReactDOM.createRoot(document.getElementById('root'));
                    
                    // Try to find and render the main component (typically HelloWorld or App)
                    if (window.HelloWorld) {
                        console.log("Rendering HelloWorld component");
                        root.render(React.createElement(window.HelloWorld));
                    } else if (window.App) {
                        console.log("Rendering App component");
                        root.render(React.createElement(window.App));
                    } else {
                        console.error("No main component found (HelloWorld or App)");
                    }
                    
                    console.log("App mounted successfully");
                } else {
                    console.error("No index.jsx file found");
                }
                
            } catch (error) {
                console.error("Error during execution:", error);
            }
        }

        // Listen for messages containing file data
        window.addEventListener('message', handleMessage);
        
        console.log("Message listener registered. Send data via window.postMessage()");
    </script>
</body>
</html>